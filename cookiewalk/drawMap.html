<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>ê°„ë‹¨í•œ ì§€ë„ í‘œì‹œí•˜ê¸°</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t0xghbfgfz"></script>
    <style>
        #map { height: 400px; }
        .legend { display: flex; justify-content: center; margin-top: 20px; }
        .legend-item { margin-right: 20px; align-items: center; display: flex; }
        .color-dot { height: 14px; width: 14px; border-radius: 50%; margin-right: 5px; }
        .red { background-color: #FF0000; }
        .green { background-color: #00FF00; }
        .blue { background-color: #0000FF; }
    </style>
</head>
<body>
<button id="startDrawing">âœï¸ ê·¸ë¦¼ ê·¸ë¦¬ê¸° ì‹œì‘</button>
<button id="stopDrawing" style="display:none;">âœ… ê·¸ë¦¼ ê·¸ë¦¬ê¸° ì¢…ë£Œ</button>
<button id="saveDrawing" style="display:none;">ğŸ’¾ ê·¸ë¦¼ ì €ì¥í•˜ê¸°</button>
<button id="viewSavedDrawing" style="display:none;">ğŸ–¼ï¸ ì €ì¥ëœ ê·¸ë¦¼ ë³´ê¸°</button>
<button id="undoDrawing" style="display:none;">â†©ï¸ ë˜ëŒë¦¬ê¸°</button>
<button id="clearDrawing" style="display:none;">ğŸ—‘ï¸ì´ˆê¸°í™”</button>
<input type="color" id="colorPicker">
<div id="map"></div>
<div class="legend">
    <div class="legend-item"><div class="color-dot red"></div>ì¶œë°œì§€</div>
    <div class="legend-item"><div class="color-dot green"></div>ë„ì°©ì§€</div>
    <div class="legend-item"><div class="color-dot blue"></div>ì¶œë°œì§€=ë„ì°©ì§€</div>
</div>
<script>
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude,
            lon = position.coords.longitude;
        var mapOptions = {
            center: new naver.maps.LatLng(lat, lon),
            zoom: 17
        };
        var map = new naver.maps.Map('map', mapOptions);

        var marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(lat, lon),
            map: map,
            icon: {
                content: '<div style="width:10px; height:10px; background-color:black; border-radius:50%;"></div>',
                anchor: new naver.maps.Point(5, 5)
            }
        });

        var drawing = false;
        var path = [];
        var currentColor = '#000000';
        var polyline = new naver.maps.Polyline({
            map: map,
            path: [],
            strokeColor: currentColor,
            strokeWeight: 3
        });

        function updatePolyline() {
            polyline.setMap(null);
            polyline = new naver.maps.Polyline({
                map: map,
                path: path,
                strokeColor: currentColor,
                strokeWeight: 3
            });
        }

        document.getElementById('colorPicker').addEventListener('change', function() {
            if (!drawing) {
                currentColor = this.value;
                updatePolyline();
            }
        });

        var zoomChangeListener; // ë³€ê²½ëœ ë¶€ë¶„: ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¸ë“¤ì„ ì €ì¥í•  ë³€ìˆ˜ ì„ ì–¸
        var startMarker, endMarker;
// ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
function onMarkerClick(e) {
    var marker = e.overlay;
    // ì¶œë°œì§€ ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œì˜ ë™ì‘ì„ ì •ì˜í•©ë‹ˆë‹¤.
    if (marker === startMarker && path.length > 0 && drawing) {
        // ì¶œë°œì§€ ë§ˆì»¤ì˜ ìƒ‰ìƒì„ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        marker.setIcon({
            content: '<div style="width:14px; height:14px; background-color:#0000FF; border-radius:50%; border: 2px solid white;"></div>',
            anchor: new naver.maps.Point(7, 7)
        });

        // ê²½ë¡œë¥¼ ë‹«ìŠµë‹ˆë‹¤. ì¦‰, ë§ˆì§€ë§‰ ì ì„ ì‹œì‘ì ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.
        path.push(path[0]);
        updatePolyline();


// ê·¸ë¦¬ê¸°ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤.
drawing = false;
        document.getElementById('startDrawing').style.display = 'inline';
        document.getElementById('stopDrawing').style.display = 'none';
        document.getElementById('undoDrawing').style.display = 'none';
        document.getElementById('clearDrawing').style.display = 'none';
        document.getElementById('saveDrawing').style.display = 'inline';
        document.getElementById('viewSavedDrawing').style.display = 'inline';
        document.getElementById('colorPicker').disabled = false;
        map.setCursor('');
    }
}




document.getElementById('startDrawing').addEventListener('click', function() {
    drawing = true;
    this.style.display = 'none';
    document.getElementById('stopDrawing').style.display = 'inline';
    document.getElementById('undoDrawing').style.display = 'inline';
    document.getElementById('clearDrawing').style.display = 'inline';
    document.getElementById('saveDrawing').style.display = 'none';
    document.getElementById('viewSavedDrawing').style.display = 'none';
    map.setCursor('crosshair');
    document.getElementById('colorPicker').disabled = true;
    path = [];
    updatePolyline();
    // ì‹œì‘ ë§ˆì»¤ ì„¤ì •
    if (startMarker) {
        startMarker.setMap(null);
    }
    if (endMarker) {
        endMarker.setMap(null);
    }
});

document.getElementById('stopDrawing').addEventListener('click', function() {
    drawing = false;
    document.getElementById('startDrawing').style.display = 'inline';
    this.style.display = 'none';
    document.getElementById('undoDrawing').style.display = 'none';
    document.getElementById('clearDrawing').style.display = 'none';
    document.getElementById('saveDrawing').style.display = 'inline';
    document.getElementById('viewSavedDrawing').style.display = 'inline';
    document.getElementById('colorPicker').disabled = false;
    map.setCursor('');
    polyline.setPath(path);
    // ë§ˆì§€ë§‰ ì ì— ë„ì°© ë§ˆì»¤ ì„¤ì •
    if (path.length > 0) {
        if (endMarker) {
            endMarker.setMap(null);
        }
        endMarker = createMarker(path[path.length - 1], '#00FF00');
    }
    if (path.length > 0) {
        if (startMarker) {
            startMarker.setMap(null);
        }
        startMarker = createMarker(path[0], '#FF0000');
    }
});

// 'startMarker' í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë§ˆì»¤ ìƒì„± ì‹œ ë°”ì¸ë”©í•˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.
function createMarker(latlng, color) {
    var marker = new naver.maps.Marker({
        position: latlng,
        map: map,
        icon: {
            content: '<div style="width:14px; height:14px; background-color:' + color + '; border-radius:50%; border: 2px solid white;"></div>',
            anchor: new naver.maps.Point(7, 7)
        }
    });

    // ë§ˆì»¤ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    naver.maps.Event.addListener(marker, 'click', onMarkerClick);

    return marker;
}

        document.getElementById('undoDrawing').addEventListener('click', function() {
            if (path.length > 0) {
                path.pop();
                updatePolyline();
            }
        });

        document.getElementById('clearDrawing').addEventListener('click', function() {
    path = [];
    updatePolyline();
    if (startMarker) {
        startMarker.setMap(null);
    }
    if (endMarker) {
        endMarker.setMap(null);
    }
});

document.getElementById('saveDrawing').addEventListener('click', function() {
    var savedMaps = JSON.parse(localStorage.getItem('savedMaps')) || [];

    var pathData = JSON.stringify(path.map(function(p) { return { lat: p.lat(), lng: p.lng() }; }));
    var colorData = currentColor;

    // ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ê°™ì€ì§€ í™•ì¸
    var isSameLocation = path.length > 0 && path[0].equals(path[path.length - 1]);

    // ì €ì¥í•  ì¶œë°œì§€ ë° ë„ì°©ì§€ ë§ˆì»¤ ìƒ‰ìƒ ê²°ì •
    var startMarkerColor, endMarkerColor;
    if (isSameLocation) {
        // ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ê°™ë‹¤ë©´ íŒŒë€ìƒ‰ìœ¼ë¡œ ì„¤ì •
        startMarkerColor = endMarkerColor = '#0000FF';
    } else {
        // ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ë‹¤ë¥´ë‹¤ë©´ ê°ê° ìƒ‰ìƒ ì„¤ì •
        startMarkerColor = '#FF0000'; // ì¶œë°œì§€ëŠ” ë¹¨ê°„ìƒ‰
        endMarkerColor = '#00FF00'; // ë„ì°©ì§€ëŠ” ì´ˆë¡ìƒ‰
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    savedMaps.push({
        path: pathData,
        color: colorData,
        startMarkerColor: startMarkerColor,
        endMarkerColor: endMarkerColor
    });

    localStorage.setItem('savedMaps', JSON.stringify(savedMaps));
    alert('ê·¸ë¦¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
});


        document.getElementById('viewSavedDrawing').addEventListener('click', function() {
            window.location.href = 'loadMap.html';
        });

       // 'map' í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ 'startMarker'ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì €ì¥í•˜ëŠ” ë¡œì§ì…ë‹ˆë‹¤.
naver.maps.Event.addListener(map, 'click', function(e) {
    if (!drawing) return;
    if (path.length === 0) {
        // ì²˜ìŒ í´ë¦­ì‹œ ì‹œì‘ ë§ˆì»¤ ì„¤ì •
        startMarker = createMarker(e.coord, '#FF0000');
    }
    path.push(e.coord);
    updatePolyline();
           // í´ë¦­í•  ë•Œë§ˆë‹¤ ìœ„ë„ì™€ ê²½ë„ë¥¼ consoleì— ì¶œë ¥
    console.log('ìœ„ë„:', e.coord._lat, 'ê²½ë„:', e.coord._lng);
});
    }, function(err) {
        console.warn(`ERROR(${err.code}): ${err.message}`);
    }, {
        maximumAge:60000,
        timeout:5000,
        enableHighAccuracy: true
    });
} else {
    alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
}
</script>
</body>
</html>